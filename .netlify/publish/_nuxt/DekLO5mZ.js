import{ap as M,r as j,j as P,q as b,aq as _,ar as K,as as G,at as H,au as X,av as Y,aw as Z,ax as ee,ay as te,az as re,aA as oe,aB as se,aC as ae,aD as ne,aE as ce,aF as ie,aG as le,aH as ue,aI as de,aJ as me,aK as fe,aL as pe,aM as we,aN as ve,aO as _e,aP as he,aQ as ye,aR as Pe,aS as be,aT as ge,aU as je,aV as Se,aW as Ee,aX as De,aY as Ie,aZ as Fe,a_ as Ae,a$ as Te,b0 as Re,b1 as Ce,b2 as Oe,b3 as Ve,b4 as ke}from"./B68XTRoa.js";const h=Object.freeze(Object.defineProperty({__proto__:null,AbstractUserDataWriter:K,Bytes:G,CollectionReference:H,DocumentReference:X,DocumentSnapshot:Y,FieldPath:Z,FieldValue:ee,Firestore:te,FirestoreError:re,GeoPoint:oe,Query:se,QueryCompositeFilterConstraint:ae,QueryConstraint:ne,QueryDocumentSnapshot:ce,QueryFieldFilterConstraint:ie,QuerySnapshot:le,SnapshotMetadata:ue,Timestamp:de,VectorValue:me,_AutoId:fe,_ByteString:pe,_DatabaseId:we,_DocumentKey:ve,_EmptyAuthCredentialsProvider:_e,_FieldPath:he,_cast:ye,_logWarn:Pe,_validateIsNotUsedTogether:be,addDoc:ge,collection:je,connectFirestoreEmulator:Se,deleteDoc:Ee,doc:De,ensureFirestoreConfigured:Ie,executeWrite:Fe,getDoc:Ae,getDocs:Te,getFirestore:Re,onSnapshot:Ce,query:Oe,updateDoc:Ve,where:ke},Symbol.toStringTag,{value:"Module"})),qe=M("projects",()=>{const i=j([]),l=j(null),w=j({}),y=j({}),g=j(!1),R=P(()=>i.value.length>0),C=P(()=>l.value?i.value.find(e=>e.id===l.value):null),O=P(()=>l.value?w.value[l.value]||{completedItems:0,totalItems:0,percentage:0}:null),V=e=>{g.value!==!1&&(l.value=e,localStorage.setItem("currentProjectId",e))},k=e=>{i.value.push(e),w.value[e.id]={completedItems:0,totalItems:0,percentage:0},y.value[e.id]=new Set},U=(e,t)=>{const r=i.value.findIndex(o=>o.id===e);r!==-1&&(i.value[r]={...i.value[r],...t})},q=e=>{i.value=i.value.filter(t=>t.id!==e),delete w.value[e],delete y.value[e],l.value===e&&(l.value=i.value.length>0?i.value[0].id:null)},x=(e,t,r)=>{const o=t.length,n=r.size,c=o>0?Math.round(n/o*100):0;w.value[e]={completedItems:n,totalItems:o,percentage:c},window._currentUserId&&S(window._currentUserId,e)},D=e=>w.value[e]||{completedItems:0,totalItems:0,percentage:0},z=e=>{w.value[e]={completedItems:0,totalItems:0,percentage:0}},I=e=>(y.value[e]||(y.value[e]=new Set),y.value[e]),F=(e,t)=>{y.value[e]=t,window._currentUserId&&S(window._currentUserId,e)},A=async e=>{try{if(!e)return;const{$db:t}=b();if(!t){console.warn("Firebase non initialisé");return}const{collection:r,query:o,where:n,onSnapshot:c,getDocs:a}=await _(async()=>{const{collection:u,query:p,where:d,onSnapshot:m,getDocs:E}=await Promise.resolve().then(()=>h);return{collection:u,query:p,where:d,onSnapshot:m,getDocs:E}},void 0,import.meta.url),s=r(t,"projects"),f=o(s,n("userId","==",e));return c(f,async u=>{const p=[];u.forEach(m=>{p.push({id:m.id,...m.data()})});const d=l.value;i.value=p,g.value=!0,d&&p.find(m=>m.id===d)?l.value=d:p.length>0&&!l.value&&(l.value=p[0].id);for(const m of p)await T(e,m.id)},u=>{console.error("Erreur de synchronisation Firebase:",u),u.code==="permission-denied"?console.error("Problème de permissions Firestore. Vérifiez que les règles sont déployées."):u.code==="unavailable"?console.error("Firestore temporairement indisponible, réessayez plus tard."):console.error("Erreur Firestore:",u.code,u.message),g.value=!1})}catch(t){console.error("Erreur lors de la synchronisation des projets:",t),t.code==="permission-denied"?console.error("Problème de permissions Firestore. Vérifiez que les règles sont déployées."):t.code==="unavailable"?console.error("Firestore temporairement indisponible, réessayez plus tard."):console.error("Erreur lors de la synchronisation:",t.message),g.value=!1}},L=async(e,t)=>{try{if(!e)throw new Error("userId requis");const{$db:r}=b();if(!r)throw new Error("Firebase non initialisé");const{collection:o,addDoc:n}=await _(async()=>{const{collection:v,addDoc:u}=await Promise.resolve().then(()=>h);return{collection:v,addDoc:u}},void 0,import.meta.url),c=o(r,"projects"),a={...t,userId:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return{id:(await n(c,a)).id,...a}}catch(r){throw console.error("Erreur lors de l'ajout du projet:",r),r}},N=async(e,t,r)=>{try{if(!e||!t)throw new Error("userId et projectId requis");const{$db:o}=b();if(!o)throw new Error("Firebase non initialisé");const{doc:n,updateDoc:c}=await _(async()=>{const{doc:f,updateDoc:v}=await Promise.resolve().then(()=>h);return{doc:f,updateDoc:v}},void 0,import.meta.url),a=n(o,"projects",t),s={...r,updatedAt:new Date().toISOString()};await c(a,s)}catch(o){throw console.error("Erreur lors de la mise à jour du projet:",o),o}},Q=async(e,t)=>{try{if(!e||!t)throw new Error("userId et projectId requis");const{$db:r}=b();if(!r)throw new Error("Firebase non initialisé");const{doc:o,deleteDoc:n}=await _(async()=>{const{doc:a,deleteDoc:s}=await Promise.resolve().then(()=>h);return{doc:a,deleteDoc:s}},void 0,import.meta.url),c=o(r,"projects",t);await n(c)}catch(r){throw console.error("Erreur lors de la suppression du projet:",r),r}},T=async(e,t)=>{try{if(!e||!t)return;const{$db:r}=b();if(!r){console.warn("Firebase non initialisé");return}const{doc:o,getDoc:n}=await _(async()=>{const{doc:s,getDoc:f}=await Promise.resolve().then(()=>h);return{doc:s,getDoc:f}},void 0,import.meta.url),c=o(r,"projects",t),a=await n(c);if(a.exists()){const s=a.data();if(s.checklistType){if(s.checkedItems&&Array.isArray(s.checkedItems)){const f=new Set(s.checkedItems);F(t,f)}s.scores&&(w.value[t]=s.scores)}}}catch(r){r.code!=="permission-denied"&&console.error("Erreur lors du chargement des éléments cochés:",r)}},S=async(e,t)=>{try{if(!e||!t)return;const{$db:r}=b();if(!r){console.warn("Firebase non initialisé");return}const o=i.value.find(a=>a.id===t);if(!o||!o.checklistType)return;const n=I(t),c=D(t);window._saveProjectTimeout&&clearTimeout(window._saveProjectTimeout),window._saveProjectTimeout=setTimeout(async()=>{try{const{doc:a,getDoc:s}=await _(async()=>{const{doc:d,getDoc:m}=await Promise.resolve().then(()=>h);return{doc:d,getDoc:m}},void 0,import.meta.url),f=a(r,"projects",t),v=await s(f);if(v.exists()){const d=v.data(),m=d.checkedItems||[],E=d.scores||{},W=JSON.stringify(Array.from(n).sort())!==JSON.stringify(m.sort()),B=JSON.stringify(c)!==JSON.stringify(E);if(!W&&!B)return}const{updateDoc:u}=await _(async()=>{const{updateDoc:d}=await Promise.resolve().then(()=>h);return{updateDoc:d}},void 0,import.meta.url),p=Array.from(n);await u(f,{checkedItems:p,scores:c,updatedAt:new Date().toISOString()})}catch(a){console.error("Erreur lors de la sauvegarde des éléments cochés:",a)}},500)}catch(r){console.error("Erreur lors de la sauvegarde des éléments cochés:",r)}},$=()=>{{const e=localStorage.getItem("currentProjectId");e&&(l.value=e)}},J=async e=>{if(e)try{window._currentUserId=e,window._projectUnsubscribe&&window._projectUnsubscribe();const t=await A(e);t&&(window._projectUnsubscribe=t)}catch(t){console.error("Erreur lors de l'initialisation de la synchronisation Firebase:",t)}};return $(),window.addEventListener("beforeunload",()=>{window._saveProjectTimeout&&clearTimeout(window._saveProjectTimeout)}),{projects:P(()=>i.value),currentProjectId:P(()=>l.value),currentProject:C,hasProjects:R,currentProjectScores:O,isSynced:P(()=>g.value),setCurrentProject:V,addProject:k,updateProject:U,removeProject:q,calculateScoresFromItems:x,getProjectScores:D,resetProjectScores:z,getCheckedSet:I,setCheckedForProject:F,subscribeUserProjects:A,addProjectRemote:L,updateProjectRemote:N,removeProjectRemote:Q,loadProjectChecked:T,saveProjectChecked:S,initializeFirebaseSync:J}});export{qe as u};
